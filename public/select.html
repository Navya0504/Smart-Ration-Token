<!DOCTYPE html>
<html>
<head>
    <title>Select Slot</title>
    <style>
        body {
            font-family: Arial;
            min-height: 100vh;
            margin: 0;
            padding: 40px;
            background: linear-gradient(135deg, #89f7fe, #66a6ff);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .box {
            background: white;
            width: 360px;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            text-align: center;
        }

        h2 {
            color: #2c3e50;
        }

        p {
            font-size: 14px;
            margin: 6px 0;
        }

        input, select, button {
            width: 90%;
            padding: 12px;
            margin: 10px 0;
            border-radius: 8px;
            border: 1px solid gray;
        }

        button {
            background: #4CAF50;
            color: white;
            border: none;
            font-size: 16px;
            cursor: pointer;
        }

        #msg {
            color: red;
            height: 18px;
        }

        option.recommended {
            background-color: #d1ffd6;
            font-weight: bold;
        }
    </style>
</head>

<body>

<div class="box">
    <h2>Select Your Slot</h2>

    <p>
        <b>Guaranteed Ration Days this month:</b><br>
        <span id="allowedDaysText">Loading...</span>
    </p>

    <input type="date" id="date">

    <select id="session">
        <option value="">Select Session</option>
        <option value="morning">Morning (9:00–12:00)</option>
        <option value="evening">Evening (4:00–7:00)</option>
    </select>

    <select id="slot">
        <option value="">Select Slot</option>
    </select>

    <button id="confirm">Confirm Token</button>
    <p id="msg"></p>
</div>

<script>
/* ---------------- BASIC ---------------- */
const params = new URLSearchParams(window.location.search);
const card = params.get("card");
if(!card) window.location.href = "login.html";

const dateInput = document.getElementById("date");
const sessionSelect = document.getElementById("session");
const slotSelect = document.getElementById("slot");
const msg = document.getElementById("msg");
const allowedDaysText = document.getElementById("allowedDaysText");

let allowedDays = [];

/* ---------------- FETCH ALLOWED DAYS ---------------- */
async function loadAllowedDays(){
    const resp = await fetch("/allowedDays");
    const data = await resp.json();

    allowedDays = data.days; // array of YYYY-MM-DD
    allowedDaysText.textContent = allowedDays.join(", ");
}

/* ---------------- CHECK USER SELECTION ---------------- */
async function loadUserSelection(){
    const resp = await fetch(`/bookingDetails?card=${card}`);
    const data = await resp.json();

    if(data.selectedDate){
        dateInput.value = data.selectedDate;
        dateInput.disabled = true;
        msg.textContent = "Ration day already fixed for this month.";
    }
}

/* ---------------- DATE VALIDATION ---------------- */
dateInput.addEventListener("change", () => {
    if(!allowedDays.includes(dateInput.value)){
        msg.textContent = "You can select only the allowed ration days.";
        dateInput.value = "";
    } else {
        msg.textContent = "";
    }
});

/* ---------------- SLOT DATA ---------------- */
const slots = {
    morning: ["9:00-9:30","9:30-10:00","10:00-10:30","10:30-11:00","11:00-11:30","11:30-12:00"],
    evening: ["4:00-4:30","4:30-5:00","5:00-5:30","5:30-6:00","6:00-6:30","6:30-7:00"]
};

const maxPerSlot = 10;

/* ---------------- UPDATE SLOTS ---------------- */
async function updateSlots(){
    slotSelect.innerHTML = '<option value="">Select Slot</option>';

    const d = dateInput.value;
    const s = sessionSelect.value;
    if(!d || !s) return;

    const results = await Promise.all(slots[s].map(async sl => {
        const r = await fetch(`/availableSlots?date=${d}&session=${s}&slot=${sl}`);
        const data = await r.json();
        return { slot: sl, count: data.count || 0 };
    }));

    let recommended = results[0].slot;
    let min = results[0].count;

    results.forEach(r => {
        if(r.count < min){
            min = r.count;
            recommended = r.slot;
        }
    });

    results.forEach(r => {
        const opt = document.createElement("option");
        opt.value = r.slot;
        opt.textContent = `${r.slot} (${r.count}/${maxPerSlot})`;
        if(r.count >= maxPerSlot) opt.disabled = true;
        if(r.slot === recommended) opt.classList.add("recommended");
        slotSelect.appendChild(opt);
    });

    slotSelect.value = recommended;
}

sessionSelect.addEventListener("change", updateSlots);

/* ---------------- CONFIRM ---------------- */
document.getElementById("confirm").addEventListener("click", async () => {
    const d = dateInput.value;
    const s = sessionSelect.value;
    const sl = slotSelect.value;

    if(!d || !s || !sl){
        msg.textContent = "Fill all details";
        return;
    }

    const resp = await fetch("/book", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ card, date: d, session: s, slot: sl })
    });

    const data = await resp.json();
    msg.textContent = data.message;

    if(data.success){
        window.location.href = `confirm.html?card=${card}&date=${d}`;
    }
});

/* ---------------- INIT ---------------- */
(async () => {
    await loadAllowedDays();
    await loadUserSelection();
})();
</script>

</body>
</html>
